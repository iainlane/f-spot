#! /usr/bin/make -f

include /usr/share/cli-common/cli.make

VERSION = $(shell dpkg-parsechangelog | grep ^Vers | cut -d\  -f2)
UPVERSION = $(shell echo $(VERSION) | sed 's,-.*,,' | sed 's,+dfsg.*,,') 

LDFLAGS += -Wl,-z,defs -Wl,-O1 -Wl,--as-needed

DEB_CONFIGURE_SCRIPT_ENV := LDFLAGS="-Wl,-O1 -Wl,--as-needed"
DEB_CONFIGURE_USER_FLAGS += MCS=/usr/bin/csc CSC=/usr/bin/csc
DEB_CONFIGURE_EXTRA_FLAGS := --disable-scrollkeeper

# robbed from tomboy
autoreconf: autoreconf-stamp
autoreconf-stamp:
	autoreconf -f -i -s
	# replace ltmain.sh with our patched one that supports --as-needed
	install --mode=755 $(CURDIR)/debian/ltmain-as-needed.sh $(CURDIR)/ltmain.sh
	touch $@

override_dh_clean:
	dh_clean
	rm -rf autoreconf-stamp configure config.sub config.guess ltmain.sh aclocal.m4 autom4te.cache/
	find . -name "Makefile.in" -delete

override_dh_auto_configure: autoreconf-stamp
	dh_auto_configure -- \
		--disable-scrollkeeper \
		LDFLAGS="$(LDFLAGS)" \
		MCS=/usr/bin/csc

override_dh_install:
	rm $(CURDIR)/debian/f-spot/usr/lib/f-spot/*.a \
	   $(CURDIR)/debian/f-spot/usr/lib/f-spot/*.la \
	   $(CURDIR)/debian/f-spot/usr/lib/f-spot/*.so
	cp $(CURDIR)/debian/NDesk.Glitz.dll.config \
	   $(CURDIR)/debian/f-spot/usr/lib/f-spot/
	dh_install

# disable tests
override_dh_auto_test:

get-orig-source:
	[ -d ../tarballs ] || mkdir ../tarballs
	uscan \
		--force-download \
		--download-version $(UPVERSION) \
		--rename \
		--destdir ../tarballs

%:
	dh --with quilt $@
